<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PageSpeed Insights Multipage</title>
    <style>
        .metric {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .metric-label {
            font-weight: bold;
        }

        .category-FAST {
            color: green;
        }

        .category-AVERAGE {
            color: orange;
        }

        .category-SLOW {
            color: red;
        }

        .no-data {
            color: #666;
            font-style: italic;
        }

        .summary {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .sub-metric {
            margin: 5px 0 5px 20px;
            font-size: 0.9em;
        }

        .error {
            color: red;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="config-form">
        <label>API Key: <input type="text" id="apiKey"></label>
        <label>URL to test: <input type="text" id="testUrl" value="https://example.com"></label>
        <label><input type="checkbox" id="useSitemap"> Process all URLs in sitemap</label>
        <button id="analyzeBtn">Analyze</button>
    </div>
    <div id="results"></div>

    <script type="module" src="/src/main.ts"></script>
    <script>
        document.getElementById('analyzeBtn').addEventListener('click', async function () {
            const apiKey = document.getElementById('apiKey').value;
            const testUrl = document.getElementById('testUrl').value;
            const useSitemap = document.getElementById('useSitemap').checked;

            if (!window.PageSpeed) {
                document.getElementById('results').innerHTML =
                    '<div style="color: red;">Error: PageSpeed client not loaded</div>';
                return;
            }

            try {
                if (useSitemap) {
                    const batchRequest = {
                        urls: [],
                        apiKey,
                        urlSource: {
                            method: 'sitemap',
                            baseUrl: testUrl
                        }
                    };
                    const results = await PageSpeed.analyzeBatch(batchRequest);
                    
                    let html = '<h2>Batch Analysis Results</h2>';
                    
                    // Summary section
                    html += `<div class="summary">
                        <h3>Summary</h3>
                        <p>Total URLs: ${results.summary.totalUrls}</p>
                        <p>Successful: ${results.summary.successfulRequests}</p>
                        <p>Failed: ${results.summary.failedRequests}</p>
                        <p>Average Performance Score: ${Math.round(results.summary.averagePerformanceScore * 100)}%</p>
                    </div>`;

                    // Individual results
                    html += '<h3>Individual Results</h3>';
                    results.results.forEach(({ url, response, error }) => {
                        html += `<div class="metric">
                            <h4>${url}</h4>`;
                        
                        if (error) {
                            html += `<div class="error">Error: ${error}</div>`;
                        } else if (response) {
                            const score = response.lighthouseResult?.categories?.performance?.score ?? 0;
                            html += `<div>Performance Score: ${Math.round(score * 100)}%</div>`;

                            // Lab Data
                            if (response.lighthouseResult?.audits) {
                                const labMetrics = [
                                    'first-contentful-paint',
                                    'speed-index',
                                    'largest-contentful-paint',
                                    'interactive',
                                    'total-blocking-time',
                                    'cumulative-layout-shift'
                                ];

                                labMetrics.forEach(metricKey => {
                                    const audit = response.lighthouseResult.audits[metricKey];
                                    if (audit) {
                                        html += `<div class="sub-metric">
                                            <span class="metric-label">${audit.title}:</span>
                                            <span>${audit.displayValue}</span>
                                        </div>`;
                                    }
                                });
                            }
                        }
                        
                        html += '</div>';
                    });

                    document.getElementById('results').innerHTML = html;
                } else {
                    const result = await PageSpeed.analyze(testUrl, apiKey);
                    console.log('Raw field data:', result.raw.loadingExperience);
                    console.log('Raw lighthouse data:', result.raw.lighthouseResult);

                    var html = '';

                    // Overall scores
                    var performanceScore = result.getPerformanceScore();
                    html += '<h2>Performance Score: ' + Math.round(performanceScore * 100) + '%</h2>';

                    // Field Data
                    html += '<h3>Field Data (Real User Metrics)</h3>';
                    if (result.raw.loadingExperience && result.raw.loadingExperience.metrics) {
                        Object.entries(result.raw.loadingExperience.metrics).forEach(([key, data]) => {
                            html += '<div class="metric">' +
                                '<span class="metric-label">' + key.replace(/_/g, ' ') + ':</span> ' +
                                '<span class="category-' + data.category + '">' +
                                data.percentile + 'ms (' + data.category + ')</span>' +
                                '</div>';
                        });
                    } else {
                        html += '<div class="no-data">No field data available for this URL</div>';
                    }

                    // Lab Data
                    html += '<h3>Lab Data (Lighthouse Results)</h3>';
                    if (result.raw.lighthouseResult && result.raw.lighthouseResult.audits) {
                        const labMetrics = [
                            'first-contentful-paint',
                            'speed-index',
                            'largest-contentful-paint',
                            'interactive',
                            'total-blocking-time',
                            'cumulative-layout-shift'
                        ];

                        labMetrics.forEach(function (metricKey) {
                            const audit = result.raw.lighthouseResult.audits[metricKey];
                            if (audit) {
                                html += '<div class="metric">' +
                                    '<span class="metric-label">' + audit.title + ':</span> ' +
                                    '<span>' + audit.displayValue + '</span>' +
                                    '</div>';
                            }
                        });
                    }

                    document.getElementById('results').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('results').innerHTML =
                    '<div class="error">' + error.message + '</div>';
            }
        });
    </script>
</body>

</html>